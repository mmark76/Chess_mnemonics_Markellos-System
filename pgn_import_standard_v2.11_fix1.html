<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chess Mnemonic System v.2.11 (fix1) — Diagnostics & Fallbacks</title>

  <!-- chess.js από CDN με απλό offline fallback (μόνο ένδειξη, δεν ενσωματώνω κώδικα) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14; --card:#121821; --muted:#1a2230; --text:#e6edf3; --sub:#a9b4c0;
      --acc:#2ea043; --border:#2d3645; --hover:#223043; --warn:#cc3d3d;
    }
    html,body{background:var(--bg); color:var(--text); margin:0; font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    .wrap{width:100%; max-width:none; margin:24px 0; padding:0 16px;}
    h1{font-size:20px; margin:12px 0 16px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:6px 0 18px;align-items:start;}
    textarea{width:100%; min-height:130px; background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:10px; resize:vertical;}
    #pgnText{ width:90%; }
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .btn{background:var(--muted); color:var(--text); border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer}
    .btn:hover{background:var(--hover)}
    input[type=file]{display:none}
    label.file{background:var(--muted); padding:8px 12px; border:1px solid var(--border); border-radius:10px; cursor:pointer}
    .section-title{margin:14px 0 6px}
    .status{background:var(--card); border:1px solid var(--border); border-radius:10px; padding:8px; margin-bottom:10px}
    .ok{color:var(--acc)} .warn{color:var(--warn)} .muted{color:var(--sub)}
    .tables{display:grid; grid-template-columns:1fr; gap:12px;}
    .subtables{display:grid; grid-template-columns: repeat(auto-fit,minmax(360px,1fr)); gap:12px;}
    .table-container{background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:auto; max-height:420px; -webkit-overflow-scrolling:touch}
    table{width:100%; border-collapse:collapse; min-width:360px; table-layout:fixed}
    thead{position:sticky; top:0; background:linear-gradient(0deg,var(--card), #0f1621)}
    th,td{padding:6px 8px; border-bottom:1px solid var(--border); text-align:center; white-space:normal; word-break:break-word;}
    td.fen, th.fen{max-width:240px;}
    td:first-child, th:first-child{width:44px}
    tr.row-hover{background:rgba(46,160,67,0.08)}
    tr.row-selected{background:rgba(46,160,67,0.18)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .small{font-size:12px}
    .foot{margin:12px 0 40px; color:var(--sub)}
    #libsPreview{text-align:left!important; direction:ltr!important; margin:0!important; padding-left:8px; white-space:pre-wrap; word-break:break-word}
    .wide{min-width:150px}
  </style>
</head>
<body>
<div class="wrap">
  <header class="cms-header">
    <h1>Chess Mnemonic System v.2.11 (fix1)</h1>
    <div class="status" id="statusBox">
      <div id="stLib">Library: <span class="muted">loading…</span></div>
      <div id="stChess">chess.js: <span class="muted">checking…</span></div>
    </div>
  </header>

  <div class="row">
    <div>
      <div class="controls" style="margin-bottom:6px">
        <label class="file" title="Φόρτωση αρχείου .pgn ή .txt">
          <input id="pgnFile" type="file" accept=".pgn,.txt"/>
          Import PGN / SAN
        </label>
        <button class="btn" id="btnParse" title="Κάνει parse του κειμένου στο πεδίο">Parse PGN / SAN</button>
        <button class="btn" id="btnClear">Καθαρισμός</button>
      </div>
      <textarea id="pgnText" placeholder="Paste PGN/SAN εδώ και πάτα ‘Parse PGN / SAN’, ή χρησιμοποίησε ‘Import PGN / SAN’ για φόρτωση αρχείου." style="width:90%; min-height:240px;"></textarea>
    </div>
    <div>
      <div class="section-title">
        <h3>Βιβλιοθήκες (προεπισκόπηση)</h3>
        <div class="table-container" id="libsContainer" style="padding:10px; max-height:320px; max-width:560px; margin:0; overflow:auto;">
          <pre id="libsPreview" class="small"></pre>
        </div>
      </div>
    </div>
  </div>

  <div class="tables">
    <div>
      <div class="section-title"><h3>SAN Table</h3></div>
      <div id="sanContainer" class="table-container">
        <table id="sanTable">
          <thead>
            <tr>
              <th>#</th><th>SAN</th><th>Side</th>
              <th class="wide">Locus</th><th class="wide">Anchor</th>
              <th>Piece / Pawn</th><th class="wide">Target Square</th>
              <th class="fen">FEN</th>
            </tr>
          </thead>
          <tbody id="sanBody"><tr><td colspan="8">Καμία κίνηση ακόμα…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="foot small">v2.11 (fix1) — Diagnostics & JSON fallbacks</div>
</div>

<script>
let libs=null;
function status(id, html){ document.getElementById(id).innerHTML = html; }

async function loadLibrariesWithFallback(){
  const candidates=[
    'libraries_v2.11_bilingual.json',
    'libraries_v2.11.json',
    'libraries_v2.10.json'
  ];
  for(const name of candidates){
    try{
      const r=await fetch(name);
      if(!r.ok) throw new Error('HTTP '+r.status);
      const json=await r.json();
      libs=json;
      status('stLib', 'Library: <span class="ok">'+name+' (OK)</span>');
      document.getElementById('libsPreview').textContent=JSON.stringify(json,null,2);
      return;
    }catch(e){
      console.warn('Failed to load', name, e);
    }
  }
  status('stLib','Library: <span class="warn">FAILED (δεν βρέθηκαν JSON αρχεία)</span>');
  document.getElementById('libsPreview').textContent='—';
}

function checkChessJS(){
  if(typeof Chess==='function'){
    status('stChess','chess.js: <span class="ok">OK</span>');
    return true;
  }else{
    status('stChess','chess.js: <span class="warn">NOT LOADED — έλεγξε σύνδεση ή βάλε local chess.min.js</span>');
    return false;
  }
}

function escapeHtml(s){
  return (s==null?'':String(s)).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
}
function formatBilingual(val){
  if(val==null) return '';
  if(typeof val==='string') return val;
  const el = (val.el ?? '').trim();
  const en = (val.en ?? '').trim();
  if(!el && !en) return '';
  if(el && en && el!==en) return `${el} (${en})`;
  return el || en;
}
function locusForMovePair(movePair){
  const L1 = libs?.Temporal?.LibraryT1 || libs?.Library1 || {};
  const keys = Object.keys(L1).map(k=>+k).sort((a,b)=>a-b);
  if(!keys.length) return '';
  const idx = ((movePair-1) % keys.length) + 1;
  const val = L1[String(idx)];
  return `${idx} — ${formatBilingual(val)}`;
}
function anchorForMovePair(movePair){
  const L2 = libs?.Temporal?.LibraryT2 || libs?.Library2 || {};
  const keys = Object.keys(L2).map(k=>+k).sort((a,b)=>a-b);
  if(!keys.length) return '';
  if(movePair%7!==0) return '—';
  const block = Math.floor(movePair/7);
  const idx = ((block-1) % keys.length) + 1;
  const val = L2[String(idx)];
  return `${block}×7 — ${formatBilingual(val)}`;
}
function pieceLetterToName(u){
  const L={P:'Pawn (Πιόνι)',N:'Knight (Ιππότης)',B:'Bishop (Αξιωματικός)',R:'Rook (Πύργος)',Q:'Queen (Βασίλισσα)',K:'King (Βασιλιάς)'};
  return L[u]||u;
}

function buildMovesDataFromPGN(pgn){
  const chess=new Chess();
  try{ chess.reset(); chess.load_pgn(pgn,{sloppy:true}); }catch(e){ console.warn('load_pgn error',e); }
  const hist=chess.history({verbose:true}), movesData=[], temp2=new Chess();
  for(let i=0;i<hist.length;i++){
    const mv=hist[i];
    temp2.move(mv);
    const fen=temp2.fen();
    const index=i, movePair=Math.floor(i/2)+1;
    const side=(i%2===0)?'White':'Black', moveNumDisplay=(i%2===0)?(movePair+'.'):(movePair+'...');
    const piece=(mv.piece||'').toUpperCase();
    const from=mv.from||''; const to=mv.to||'';
    movesData.push({index,movePair,moveNumDisplay,san:mv.san,side,piece,from,to,fen});
  }
  return movesData;
}

function fillSanTable(movesData){
  const body=document.getElementById('sanBody');
  if(!movesData.length){ body.innerHTML='<tr><td colspan="8">Καμία κίνηση ακόμα…</td></tr>'; return; }
  body.innerHTML='';
  movesData.forEach(m=>{
    const locus = locusForMovePair(m.movePair);
    const anchor = anchorForMovePair(m.movePair);
    const toDesc = formatBilingual(libs?.Spatial?.LibraryS1?.[m.to] || libs?.Library6?.[m.to]) || m.to;
    const tr=document.createElement('tr'); tr.setAttribute('data-index',String(m.index));
    tr.innerHTML=
      `<td>${escapeHtml(m.moveNumDisplay)}</td>`+
      `<td>${escapeHtml(m.san)}</td>`+
      `<td>${escapeHtml(m.side)}</td>`+
      `<td class="wide" style="text-align:left">${escapeHtml(locus)}</td>`+
      `<td class="wide" style="text-align:left">${escapeHtml(anchor)}</td>`+
      `<td>${escapeHtml(pieceLetterToName(m.piece))}</td>`+
      `<td class="wide" style="text-align:left">${escapeHtml(toDesc)}</td>`+
      `<td class="fen mono small">${escapeHtml(m.fen)}</td>`;
    body.appendChild(tr);
  });
}

(function boot(){
  loadLibrariesWithFallback();
  const chessOk = checkChessJS();

  document.getElementById('pgnFile').addEventListener('change',e=>{
    const f=e.target.files[0]; if(!f) return;
    const rd=new FileReader();
    rd.onload=()=>{ document.getElementById('pgnText').value=rd.result; };
    rd.readAsText(f);
  });
  document.getElementById('btnParse').addEventListener('click',()=>{
    if(typeof Chess!=='function'){ alert('Το chess.js δεν φορτώθηκε. Άνοιξε τη σελίδα μέσω HTTP server ή έλεγξε το internet.'); return; }
    const raw=document.getElementById('pgnText').value||'';
    const pgn=raw.replace(/\{\s*\[%[\s\S]*?\]\s*\}/gi, '').trim();
    const moves=buildMovesDataFromPGN(pgn);
    fillSanTable(moves);
  });
  document.getElementById('btnClear').addEventListener('click',()=>{
    document.getElementById('pgnText').value='';
    document.getElementById('sanBody').innerHTML='<tr><td colspan="8">Καμία κίνηση ακόμα…</td></tr>';
  });
})();
</script>
</body>
</html>
