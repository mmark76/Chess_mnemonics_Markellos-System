<!DOCTYPE html>
<html lang="el">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PGN Import Standard v2.9.7 — SAN / PAO / Associations</title>

<!-- Stable chess.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<style>
  :root{
    --bg:#0b0f14; --card:#121821; --muted:#1a2230; --text:#e6edf3; --sub:#a9b4c0;
    --acc:#2ea043; --border:#2d3645; --hover:#223043;
  }
  html,body{background:var(--bg); color:var(--text); margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
  .wrap{width:100%; max-width:none; margin:24px 0; padding:0 16px;}
  h1{font-size:20px; margin:12px 0 16px}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:6px 0 18px;}
  textarea{width:100%; min-height:130px; background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:10px; resize:vertical;}
  #pgnText { width:90%; }
  .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .btn{background:var(--muted); color:var(--text); border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer}
  .btn:hover{background:var(--hover)}
  input[type=file]{display:none}
  label.file{background:var(--muted); padding:8px 12px; border:1px solid var(--border); border-radius:10px; cursor:pointer}
  .section-title{margin:14px 0 6px}

  /* Layout for tables: SAN full width on top, PAO+Associations below */
  .tables{display:grid; grid-template-columns:1fr; gap:12px;}
  .subtables{display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:12px;}

  .table-container{background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:auto; max-height:420px}
  table{width:100%; border-collapse:collapse; min-width:300px}
  thead{position:sticky; top:0; background:linear-gradient(0deg,var(--card), #0f1621)}
  th,td{padding:6px 8px; border-bottom:1px solid var(--border); text-align:center; white-space:normal; word-break:break-word;}
  td.fen, th.fen{max-width:200px;} /* wrap FEN column */
  td:first-child, th:first-child{width:44px}
  tr.row-hover{background:rgba(46,160,67,0.08)}
  tr.row-selected{background:rgba(46,160,67,0.18)}
  .muted{color:var(--sub)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  .small{font-size:12px}
  .foot{margin:12px 0 40px; color:var(--sub)}
  #libsPreview{ text-align:left!important; direction:ltr!important; margin:0!important; padding-left:8px; white-space:pre-wrap; word-break:break-word; }
</style>
</head>

<body>
  <div class="wrap">
    <h1>PGN Import Standard v2.9.7 — SAN / PAO / Associations</h1>
    <div class="row">
      <div>
        <div class="controls" style="margin-bottom:6px">
          <label class="file">
            <input id="pgnFile" type="file" accept=".pgn,.txt"/>
            Επιλογή αρχείου PGN
          </label>
          <button class="btn" id="btnParse">Import PGN</button>
          <button class="btn" id="btnClear">Καθαρισμός</button>
        </div>
       <textarea id="pgnText" placeholder="Επικόλλησε εδώ PGN…" style="width:90%">Επικόλλησε εδώ το PGN/SAN ...</textarea>
      </div>
     <div>
  <div class="section-title"><h3 style="padding:100px; Ρυθμίσεις Βιβλιοθηκών (from libraries.json)</h3></div>
  <div class="table-container" id="libsContainer" style="padding:10px; max-height:300px; max-width:450px; margin:0 auto; overflow:auto;">
    <pre id="libsPreview" class="small" style="white-space:pre-wrap; word-break:break-word; width:100%; margin:0 auto; padding-left:8px; text-align:left; direction:ltr;"></pre>
  </div>
</div>
      </div>
    </div>

    <div class="tables">
      <!-- SAN Table -->
      <div>
        <div class="section-title"><h3>SAN Table</h3></div>
        <div id="sanContainer" class="table-container">
          <table id="sanTable">
            <thead>
              <tr><th>#</th><th>SAN</th><th>Side</th><th>Piece</th><th>To</th><th class="fen">FEN</th></tr>
            </thead>
            <tbody id="sanBody"><tr><td colspan="6">Καμία κίνηση ακόμα…</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- PAO + Associations κάτω -->
      <div class="subtables">
        <div>
          <div class="section-title"><h3>Πίνακας PAO</h3></div>
          <div id="paoContainer" class="table-container">
            <table id="paoTable">
              <thead><tr><th>#</th><th>SAN</th><th>Side</th><th>Locus</th><th>PAO</th></tr></thead>
              <tbody id="paoBody"><tr><td colspan="5">Καμία κίνηση ακόμα…</td></tr></tbody>
            </table>
          </div>
        </div>
        <div>
          <div class="section-title"><h3>Πίνακας Associations</h3></div>
          <div id="assocContainer" class="table-container">
            <table id="assocTable">
              <thead><tr><th>#</th><th>SAN</th><th>Side</th><th>Locus</th><th>Piece</th><th>To</th></tr></thead>
              <tbody id="assocBody"><tr><td colspan="6">Καμία κίνηση ακόμα…</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="foot small">v2.9.7 — SAN επάνω, PAO+Associations κάτω, libraries από το αρχείο libraries.json</div>
  </div>

<script>
/* --------------------- Φόρτωση κανονικών Libraries --------------------- */
let libraries = null;

function loadLibraries(){
  return fetch('libraries.json')
    .then(r => {
      if(!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    })
    .then(d => {
      libraries = d;
      console.log("Libraries fetched:", libraries);
let jsonString = JSON.stringify(libraries, null, 2).replace(/[\u202A-\u202E\u200E\u200F\uFEFF]/g, '');
document.getElementById('libsPreview').textContent = jsonString;
    })
    .catch(err => {
      console.error("libraries.json load failed", err);
      document.getElementById('libsPreview').textContent =
        "Αποτυχία φόρτωσης libraries.json";
    });
}
/* ---------------------------- Parsing / Moves ---------------------------- */
function escapeHtml(s){
  return (s==null?'':String(s)).replace(/[&<>"']/g,
    m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
}
function fenPieceAt(fen, sq){
  if(!fen||!/^[a-h][1-8]$/.test(sq)) return null;
  const board=fen.split(' ')[0], rows=board.split('/');
  const fileIdx=sq.charCodeAt(0)-97, rankIdx=8-parseInt(sq[1],10);
  let col=0;
  for(const ch of rows[rankIdx]){
    if(/\d/.test(ch)) col+=+ch;
    else { if(col===fileIdx) return ch; col++; }
  }
  return null;
}
function pieceLetterToGreekName(u){
  const L={P:'Στρατιώτης',N:'Ίππος',B:'Αξιωματικός',R:'Πύργος',Q:'Βασίλισσα',K:'Βασιλιάς'};
  return L[u]||u;
}

function buildMovesDataFromPGN(pgn){
  if(typeof Chess==="undefined"){console.error("Chess.js δεν φορτώθηκε"); return [];}
  const chess=new Chess();
  try{ chess.reset(); chess.load_pgn(pgn,{sloppy:true}); }catch(e){ console.warn("load_pgn error",e); }
  const hist=chess.history({verbose:true}), movesData=[], temp2=new Chess();
  for(let i=0;i<hist.length;i++){
    const mv=hist[i]; temp2.move(mv);
    const fen=temp2.fen(), index=i, movePair=Math.floor(i/2)+1;
    const side=(i%2===0)?'White':'Black', moveNumDisplay=(i%2===0)?(movePair+'.'):(movePair+'...');
    movesData.push({index,movePair,moveNumDisplay,san:mv.san,side,piece:(mv.piece||'').toUpperCase(),to:mv.to,fen});
  }
  return movesData;
}

/* ---------------------------- Fill Tables -------------------------------- */
function fillSanTable(movesData){
  const body=document.getElementById('sanBody');
  if(!movesData.length){body.innerHTML='<tr><td colspan="6">Καμία κίνηση ακόμα…</td></tr>'; return;}
  body.innerHTML='';
  movesData.forEach(m=>{
    const tr=document.createElement('tr'); tr.setAttribute('data-index',String(m.index));
    tr.innerHTML=`<td>${escapeHtml(m.moveNumDisplay)}</td><td>${escapeHtml(m.san)}</td><td>${escapeHtml(m.side)}</td><td>${escapeHtml(m.piece)}</td><td>${escapeHtml(m.to)}</td><td class="fen mono small">${escapeHtml(m.fen)}</td>`;
    body.appendChild(tr);
  });
}

function fillPaoTableFromMoves(movesData){
  const body=document.getElementById('paoBody');
  if(!movesData.length){body.innerHTML='<tr><td colspan="5">Καμία κίνηση ακόμα…</td></tr>'; return;}
  body.innerHTML='';
  const L1=libraries.Library1||{},L7=libraries.Library7||{},L1Count=Object.keys(L1).length||0;
  const pieceMap={P:'1',N:'2',B:'3',R:'4',Q:'5',K:'6'}, fileMap={a:'1',b:'2',c:'3',d:'4',e:'5',f:'6',g:'7',h:'8'};
  movesData.forEach(m=>{
    const p=pieceMap[m.piece]||'0',f=fileMap[m.to[0]]||'0',r=m.to[1]||'0';
    const idx=L1Count?((m.movePair-1)%L1Count)+1:m.movePair, locus=L1[String(idx)]||'', locusDisp=locus?`${idx} — ${locus}`:String(idx);
    const person=(L7.Persons||{})[p]||'', action=(L7.Actions||{})[f]||'', object=(L7.Objects||{})[r]||'';
    const tr=document.createElement('tr'); tr.setAttribute('data-index',String(m.index));
    tr.innerHTML=`<td>${escapeHtml(m.moveNumDisplay)}</td><td>${escapeHtml(m.san)}</td><td>${escapeHtml(m.side)}</td><td style="text-align:left">${escapeHtml(locusDisp)}</td><td style="text-align:left"><div><strong>Κωδικός:</strong> ${escapeHtml(p+f+r)} <span class="muted small">(${escapeHtml(m.piece+m.to)})</span></div><div><strong>P:</strong> ${escapeHtml(person)} &nbsp; <strong>A:</strong> ${escapeHtml(action)} &nbsp; <strong>O:</strong> ${escapeHtml(object)}</div></td>`;
    body.appendChild(tr);
  });
}

function fillAssociationsTableFromMoves(movesData){
  const body=document.getElementById('assocBody');
  if(!movesData.length){body.innerHTML='<tr><td colspan="6">Καμία κίνηση ακόμα…</td></tr>'; return;}
  body.innerHTML='';
  const L1=libraries.Library1||{},L5=libraries.Library5||{},L6=libraries.Library6||{},L1Count=Object.keys(L1).length||0;
  movesData.forEach(m=>{
    const idx=L1Count?((m.movePair-1)%L1Count)+1:m.movePair, locus=L1[String(idx)]||'', locusDisp=locus?`${idx} — ${locus}`:String(idx);
    let ch=fenPieceAt(m.fen,m.to),u=(ch||m.piece||'').toString().toUpperCase(); if(u.length>1)u=u[0];
    const pieceAssoc=L5[u]||pieceLetterToGreekName(u), toDesc=L6[m.to]||m.to;
    const tr=document.createElement('tr'); tr.setAttribute('data-index',String(m.index));
    tr.innerHTML=`<td>${escapeHtml(m.moveNumDisplay)}</td><td>${escapeHtml(m.san)}</td><td>${escapeHtml(m.side)}</td><td style="text-align:left">${escapeHtml(locusDisp)}</td><td style="text-align:left">${escapeHtml(pieceAssoc)}</td><td style="text-align:left">${escapeHtml(toDesc)}</td>`;
    body.appendChild(tr);
  });
}

/* -------------------------- Row events ----------------------------------- */
function attachRowEvents(){
  const getRows=(idx)=>({san:document.querySelector(`#sanBody tr[data-index="${idx}"]`),pao:document.querySelector(`#paoBody tr[data-index="${idx}"]`),assoc:document.querySelector(`#assocBody tr[data-index="${idx}"]`)});
  function highlight(idx,add,cls){const rs=getRows(idx);['san','pao','assoc'].forEach(k=>{if(rs[k])rs[k].classList[add?'add':'remove'](cls);});}
  function bind(sel){document.querySelectorAll(`${sel} tr[data-index]`).forEach(tr=>{const idx=tr.getAttribute('data-index');tr.onmouseenter=()=>highlight(idx,true,'row-hover');tr.onmouseleave=()=>highlight(idx,false,'row-hover');tr.onclick=()=>{document.querySelectorAll('tr.row-selected').forEach(r=>r.classList.remove('row-selected'));highlight(idx,true,'row-selected');};});}
  bind('#sanBody'); bind('#paoBody'); bind('#assocBody');
}

/* -------------------------- Actions -------------------------------------- */
function parseFromTextarea(){
  if(!libraries){console.warn("Libraries not loaded yet"); return;}
  const text=document.getElementById('pgnText').value.trim();
  const movesData=buildMovesDataFromPGN(text);
  fillSanTable(movesData); fillPaoTableFromMoves(movesData); fillAssociationsTableFromMoves(movesData); attachRowEvents();
}
document.getElementById('btnParse').addEventListener('click',parseFromTextarea);
document.getElementById('btnClear').addEventListener('click',()=>{
  document.getElementById('pgnText').value='';
  document.getElementById('sanBody').innerHTML='<tr><td colspan="6">Καμία κίνηση ακόμα…</td></tr>';
  document.getElementById('paoBody').innerHTML='<tr><td colspan="5">Καμία κίνηση ακόμα…</td></tr>';
  document.getElementById('assocBody').innerHTML='<tr><td colspan="6">Καμία κίνηση ακόμα…</td></tr>';
});
document.getElementById('pgnFile').addEventListener('change',(ev)=>{
  const f=ev.target.files&&ev.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=(e)=>{document.getElementById('pgnText').value=e.target.result; parseFromTextarea();};
  reader.readAsText(f,'utf-8');
});

/* ----------------------- Εκκίνηση ---------------------------------------- */
window.addEventListener('load',()=>{ loadLibraries().then(()=>parseFromTextarea()); });
</script>
</body>
</html>

































