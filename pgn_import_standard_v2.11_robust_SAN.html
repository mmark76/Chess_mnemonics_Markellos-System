<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chess Mnemonic System v.2.11 — Robust SAN</title>
  <script>
    // Πρώτα επιχειρούμε να φορτώσουμε LOCAL chess.min.js (τοποθέτησέ το δίπλα στο HTML)
    (function(){
      var s=document.createElement('script');
      s.src='./chess.min.js';
      s.onload=function(){ console.log('Local chess.min.js loaded'); };
      s.onerror=function(){
        console.warn('Local chess.min.js not found, trying CDN…');
        var c=document.createElement('script');
        c.src='https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js';
        c.onload=function(){ console.log('CDN chess.js loaded'); };
        c.onerror=function(){ console.error('Failed to load chess.js from both local and CDN'); };
        document.head.appendChild(c);
      };
      document.head.appendChild(s);
    })();
  </script>
  <style>
    :root{
      --bg:#0b0f14; --card:#121821; --muted:#1a2230; --text:#e6edf3; --sub:#a9b4c0;
      --acc:#2ea043; --border:#2d3645; --hover:#223043; --warn:#cc3d3d;
    }
    html,body{background:var(--bg); color:var(--text); margin:0; font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    .wrap{width:100%; max-width:none; margin:24px 0; padding:0 16px;}
    h1{font-size:20px; margin:12px 0 16px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:6px 0 18px;align-items:start;}
    textarea{width:100%; min-height:220px; background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:10px; resize:vertical;}
    #pgnText{ width:90%; }
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .btn{background:var(--muted); color:var(--text); border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer}
    .btn:hover{background:var(--hover)}
    input[type=file]{display:none}
    label.file{background:var(--muted); padding:8px 12px; border:1px solid var(--border); border-radius:10px; cursor:pointer}
    .section-title{margin:14px 0 6px}
    .status{background:var(--card); border:1px solid var(--border); border-radius:10px; padding:8px; margin:8px 0}
    .ok{color:var(--acc)} .warn{color:var(--warn)} .muted{color:var(--sub)}
    .table-container{background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:auto; max-height:420px}
    table{width:100%; border-collapse:collapse; min-width:360px; table-layout:fixed}
    thead{position:sticky; top:0; background:linear-gradient(0deg,var(--card), #0f1621)}
    th,td{padding:6px 8px; border-bottom:1px solid var(--border); text-align:center; white-space:normal; word-break:break-word;}
    td:first-child, th:first-child{width:44px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Chess Mnemonic System v.2.11 — Robust SAN</h1>
  <div class="status">
    <div id="stLib">Library: <span class="muted">loading…</span></div>
    <div id="stChess">chess.js: <span class="muted">checking…</span></div>
    <div id="stParse">parse: <span class="muted">—</span></div>
  </div>

  <div class="row">
    <div>
      <div class="controls" style="margin-bottom:6px">
        <label class="file">
          <input id="pgnFile" type="file" accept=".pgn,.txt"/>
          Import PGN / SAN
        </label>
        <button class="btn" id="btnParse">Parse PGN / SAN</button>
        <button class="btn" id="btnClear">Καθαρισμός</button>
      </div>
      <textarea id="pgnText" placeholder="Paste PGN/SAN ή κάνε Import αρχείο."></textarea>
    </div>
    <div>
      <div class="section-title"><h3>Βιβλιοθήκες</h3></div>
      <div class="table-container" style="padding:8px">
        <pre id="libsPreview" class="mono" style="white-space:pre-wrap; word-break:break-word; font-size:12px; margin:0"></pre>
      </div>
    </div>
  </div>

  <div class="section-title"><h3>SAN Table</h3></div>
  <div id="sanContainer" class="table-container">
    <table id="sanTable">
      <thead>
        <tr>
          <th>#</th><th>SAN</th><th>Side</th><th>Locus</th><th>Anchor</th><th>Piece/Pawn</th><th>Target</th><th>FEN</th>
        </tr>
      </thead>
      <tbody id="sanBody"><tr><td colspan="8">Καμία κίνηση ακόμα…</td></tr></tbody>
    </table>
  </div>
</div>

<script>
let libs=null;
function st(id, html){ document.getElementById(id).innerHTML = html; }

async function loadLibraries(){
  const names=['libraries_v2.11_bilingual.json','libraries_v2.11.json','libraries_v2.10.json'];
  for(const n of names){
    try{
      const r=await fetch(n); if(!r.ok) throw new Error('HTTP '+r.status);
      libs=await r.json(); st('stLib','Library: <span class="ok">'+n+' (OK)</span>');
      document.getElementById('libsPreview').textContent=JSON.stringify(libs,null,2);
      return;
    }catch(e){ console.warn('Failed', n, e); }
  }
  st('stLib','Library: <span class="warn">FAILED</span>');
}

function chessReady(){ const ok = (typeof Chess==='function'); st('stChess','chess.js: '+(ok?'<span class="ok">OK</span>':'<span class="warn">NOT LOADED</span>')); return ok; }

function cleanPGN(pgn){
  return (pgn||'').replace(/\{\s*\[%[\s\S]*?\]\s*\}/gi,'').replace(/\ufeff/g,'').trim();
}
function pieceLetterToName(u){
  const L={P:'Pawn (Πιόνι)',N:'Knight (Ιππότης)',B:'Bishop (Αξιωματικός)',R:'Rook (Πύργος)',Q:'Queen (Βασίλισσα)',K:'King (Βασιλιάς)'};
  return L[u]||u;
}
function formatBilingual(val){
  if(val==null) return '';
  if(typeof val==='string') return val;
  const el=(val.el??'').trim(), en=(val.en??'').trim();
  if(el && en && el!==en) return el+' ('+en+')';
  return el || en;
}
function locusForMovePair(n){
  const L1 = libs?.Temporal?.LibraryT1 || libs?.Library1 || {};
  const keys = Object.keys(L1).map(k=>+k).sort((a,b)=>a-b);
  if(!keys.length) return '';
  const idx = ((n-1)%keys.length)+1;
  const val = L1[String(idx)];
  return idx+' — '+formatBilingual(val);
}
function anchorForMovePair(n){
  const L2 = libs?.Temporal?.LibraryT2 || libs?.Library2 || {};
  const keys = Object.keys(L2).map(k=>+k).sort((a,b)=>a-b);
  if(!keys.length) return '';
  if(n%7!==0) return '—';
  const block=Math.floor(n/7);
  const idx=((block-1)%keys.length)+1;
  const val=L2[String(idx)];
  return block+'×7 — '+formatBilingual(val);
}

function buildMoves_via_loadPGN(pgn){
  try{
    const ch=new Chess();
    ch.reset();
    const ok = ch.load_pgn(pgn,{sloppy:true});
    if(!ok) return null;
    const hist=ch.history({verbose:true});
    const temp=new Chess();
    const rows=[];
    for(let i=0;i<hist.length;i++){
      const mv=hist[i]; temp.move(mv);
      const movePair=Math.floor(i/2)+1;
      rows.push({
        index:i,
        movePair:movePair,
        moveNumDisplay:(i%2===0)?(movePair+'.'):(movePair+'...'),
        san:mv.san,
        side:(i%2===0)?'White':'Black',
        piece:(mv.piece||'').toUpperCase(),
        from:mv.from||'',
        to:mv.to||'',
        fen:temp.fen()
      });
    }
    return rows;
  }catch(e){ console.warn('load_pgn failed', e); return null; }
}
function buildMoves_token_fallback(pgn){
  try{
    const ch=new Chess();
    const txt = pgn.replace(/\d+\.(\.\.)?/g,' ').replace(/\s+/g,' ').trim();
    const toks = txt.split(' ').filter(Boolean);
    const rows=[];
    const temp=new Chess();
    toks.forEach((t,i)=>{
      try{
        const mv=temp.move(t,{sloppy:true});
        if(mv){
          const idx=i, movePair=Math.floor(i/2)+1;
          rows.push({
            index:idx,
            movePair:movePair,
            moveNumDisplay:(i%2===0)?(movePair+'.'):(movePair+'...'),
            san:mv.san,
            side:(i%2===0)?'White':'Black',
            piece:(mv.piece||'').toUpperCase(),
            from:mv.from||'',
            to:mv.to||'',
            fen:temp.fen()
          });
        }
      }catch(e){ /* ignore bad token */ }
    });
    return rows;
  }catch(e){ console.warn('token fallback failed', e); return []; }
}

function parsePGNtoMoves(pgnRaw){
  if(!chessReady()){ alert('chess.js δεν φορτώθηκε. Βάλε το chess.min.js δίπλα στο HTML ή άνοιξέ το μέσω HTTP.'); return []; }
  const pgn=cleanPGN(pgnRaw);
  let rows = buildMoves_via_loadPGN(pgn);
  if(!rows || !rows.length){
    // αν δεν υπάρχουν PGN headers, δοκίμασε να προσθέσεις μίνιμαλ headers
    const header='[Event ""]\n[Site ""]\n[Date "????.??.??"]\n[Round "?"]\n[White ""]\n[Black ""]\n[Result "*"]\n\n';
    rows = buildMoves_via_loadPGN(header+pgn) || [];
  }
  if(!rows.length){
    // fallback: token-by-token
    rows = buildMoves_token_fallback(pgn) || [];
  }
  st('stParse','parse: '+(rows.length?'<span class="ok">'+rows.length+' moves</span>':'<span class="warn">0 moves</span>'));
  return rows;
}

function renderSAN(rows){
  const body=document.getElementById('sanBody');
  if(!rows.length){ body.innerHTML='<tr><td colspan="8">Καμία κίνηση ακόμα…</td></tr>'; return; }
  body.innerHTML='';
  rows.forEach(m=>{
    const locus=locusForMovePair(m.movePair);
    const anchor=anchorForMovePair(m.movePair);
    const toDesc = (libs?.Spatial?.LibraryS1 && libs.Spatial.LibraryS1[m.to]) ? formatBilingual(libs.Spatial.LibraryS1[m.to]) : (m.to||'');
    const tr=document.createElement('tr');
    tr.innerHTML=
      `<td>${m.moveNumDisplay}</td>`+
      `<td>${m.san}</td>`+
      `<td>${m.side}</td>`+
      `<td>${locus}</td>`+
      `<td>${anchor}</td>`+
      `<td>${pieceLetterToName(m.piece)}</td>`+
      `<td>${toDesc}</td>`+
      `<td class="mono" style="font-size:12px">${m.fen}</td>`;
    body.appendChild(tr);
  });
}

(async function boot(){
  await loadLibraries();
  document.getElementById('pgnFile').addEventListener('change',e=>{
    const f=e.target.files[0]; if(!f) return;
    const rd=new FileReader();
    rd.onload=()=>{ document.getElementById('pgnText').value=rd.result; };
    rd.readAsText(f);
  });
  document.getElementById('btnParse').addEventListener('click',()=>{
    const raw=document.getElementById('pgnText').value||'';
    const rows=parsePGNtoMoves(raw);
    renderSAN(rows);
  });
  document.getElementById('btnClear').addEventListener('click',()=>{
    document.getElementById('pgnText').value='';
    document.getElementById('sanBody').innerHTML='<tr><td colspan="8">Καμία κίνηση ακόμα…</td></tr>';
    st('stParse','parse: <span class="muted">—</span>');
  });
})();
</script>
</body>
</html>
